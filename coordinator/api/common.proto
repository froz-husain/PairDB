syntax = "proto3";

package proto;

import "api/coordinator.proto";

option go_package = "github.com/devrev/pairdb/coordinator/pkg/proto;proto";

// ============================================================================
// Common Storage Messages (Shared between StorageService and StorageNodeService)
// ============================================================================

// KeyValueEntry represents a complete key-value pair with metadata
message KeyValueEntry {
  string tenant_id = 1;
  string key = 2;
  bytes value = 3;
  VectorClock vector_clock = 4;
  int64 timestamp = 5;
}

// WriteRequest is sent to write data
message WriteRequest {
  string tenant_id = 1;
  string key = 2;
  bytes value = 3;
  VectorClock vector_clock = 4;
  string idempotency_key = 5;  // Optional, for logging
  int64 timestamp = 6;  // Unix timestamp in milliseconds
}

// WriteResponse confirms successful write
message WriteResponse {
  bool success = 1;
  string key = 2;
  VectorClock vector_clock = 3;  // Updated vector clock
  string error_message = 4;
}

// ReadRequest is sent to read data
message ReadRequest {
  string tenant_id = 1;
  string key = 2;
}

// ReadResponse returns the value and metadata
message ReadResponse {
  bool success = 1;
  string key = 2;
  bytes value = 3;
  VectorClock vector_clock = 4;
  int64 timestamp = 5;  // Unix timestamp in milliseconds
  bool found = 6;  // false if key not found
  string error_message = 7;
}

// DeleteRequest is sent to delete a key
message DeleteRequest {
  string tenant_id = 1;
  string key = 2;
  VectorClock vector_clock = 3;
}

// DeleteResponse confirms deletion
message DeleteResponse {
  bool success = 1;
  string key = 2;
  string error_message = 3;
}

// RepairRequest is sent during read repair
message RepairRequest {
  string tenant_id = 1;
  string key = 2;
  bytes value = 3;
  VectorClock vector_clock = 4;
  int64 timestamp = 5;
}

// RepairResponse confirms repair operation
message RepairResponse {
  bool success = 1;
  string key = 2;
  string error_message = 3;
}

// HealthCheckRequest checks node health
message HealthCheckRequest {
  string service = 1;
}

// HealthCheckResponse returns health status
message HealthCheckResponse {
  enum ServingStatus {
    UNKNOWN = 0;
    SERVING = 1;
    NOT_SERVING = 2;
  }
  ServingStatus status = 1;
}
